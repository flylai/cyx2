# CYX2

This is my graduation project, I wrote it to learn something interesting about compilation theory.

Using SSA form, and implements the constant folding, constant propagation, dead code elimination and other optimizations, generates VM code and peephole optimization, and finally generated bytecode to file, the virtual machine interpret and execute it.

This project include:
1. CYX2 language, C like syntax.
2. A Compiler, including hand-write parser and some optimizations.
3. A Virtual Machine, register based VM, very simple and NAIVE.

# Syntax

```text
// this is a simple sample
// check the test/testcase for more details

def main() {
    for (i = 0; i < 10; i++) {
        if (i == 3) { continue }
        println(hello("World " + (i + 1)))
        if (i == 6) { break }
    }
}

def hello(str) {
    a = ["H"]
    a += "e";
    return a[0] + a[1] + "llo " + str
}
```

<img src="https://g.gravizo.com/svg?%20digraph%20G%20%7B%0A%20%20%20%20L1%20%5Bshape%3Drecord%2C%20label%3D%22%7BL1%7Ca%20%3D%20%5BH(string)%2C%20%5D%7Ca%20%3D%20a%20%2B%20e(string)%7Ct1%20%3D%20a%5B0(int)%5D%20%2B%20a%5B1(int)%5D%7Ct2%20%3D%20t1%20%2B%20llo%20(string)%7Ct3%20%3D%20t2%20%2B%20str%7CRETURN%20t3%7D%22%5D%3B%0A%20%20%20%20L2%20%5Bshape%3Drecord%2C%20label%3D%22%7BL2%7D%22%5D%3B%0A%20%20%20%20L2%20-%3E%20L3%3B%0A%20%20%20%20L3%20%5Bshape%3Drecord%2C%20label%3D%22%7BL3%7Ci%20%3D%200(int)%7D%22%5D%3B%0A%20%20%20%20L3%20-%3E%20L4%3B%0A%20%20%20%20L4%20%5Bshape%3Drecord%2C%20label%3D%22%7BL4%7Ct4%20%3D%20i%20%5C%3C%2010(int)%7Cif%20t4%20then%20goto%20L6%20else%20goto%20L15%20%7D%22%5D%3B%0A%20%20%20%20L4%20-%3E%20L6%3B%0A%20%20%20%20L4%20-%3E%20L15%3B%0A%20%20%20%20L6%20%5Bshape%3Drecord%2C%20label%3D%22%7BL6%7Ct5%20%3D%20i%20%3D%3D%203(int)%7Cif%20t5%20then%20goto%20L7%20else%20goto%20L9%20%7D%22%5D%3B%0A%20%20%20%20L6%20-%3E%20L9%3B%0A%20%20%20%20L6%20-%3E%20L7%3B%0A%20%20%20%20L7%20%5Bshape%3Drecord%2C%20label%3D%22%7BL7%7Cjmp%20L14%7D%22%5D%3B%0A%20%20%20%20L7%20-%3E%20L14%3B%0A%20%20%20%20L9%20%5Bshape%3Drecord%2C%20label%3D%22%7BL9%7Ct6%20%3D%20i%20%2B%201(int)%7Ct7%20%3D%20World%20(string)%20%2B%20t6%7Ct8%20%3D%20%40hello%231(t7%2C%20)%7Ct9%20%3D%20println(t8%2C%20)%7D%22%5D%3B%0A%20%20%20%20L9%20-%3E%20L10%3B%0A%20%20%20%20L10%20%5Bshape%3Drecord%2C%20label%3D%22%7BL10%7Ct10%20%3D%20i%20%3D%3D%206(int)%7Cif%20t10%20then%20goto%20L11%20else%20goto%20L14%20%7D%22%5D%3B%0A%20%20%20%20L10%20-%3E%20L14%3B%0A%20%20%20%20L10%20-%3E%20L11%3B%0A%20%20%20%20L11%20%5Bshape%3Drecord%2C%20label%3D%22%7BL11%7Cjmp%20L15%7D%22%5D%3B%0A%20%20%20%20L11%20-%3E%20L15%3B%0A%20%20%20%20L14%20%5Bshape%3Drecord%2C%20label%3D%22%7BL14%7Ct11%20%3D%20i%7Ci%20%3D%20i%20%2B%201(int)%7Cjmp%20L4%7D%22%5D%3B%0A%20%20%20%20L14%20-%3E%20L4%3B%0A%20%20%20%20L15%20%5Bshape%3Drecord%2C%20label%3D%22%7BL15%7CRETURN%20%7D%22%5D%3B%0A%20%7D">

# Architecture

![](https://mermaid.ink/img/eyJjb2RlIjoiZ3JhcGggTFI7XG5Tb3VyY2VDb2RlW1NvdXJjZTxici8-Q29kZV0tLUFTQ0lJPGJyLz5UZXh0LS0-TGV4ZXItLVRva2VuLS0-UGFyc2VyLS1BU1QtLT5JUkdlbmVyYXRvcltJUjxici8-R2VuZXJhdG9yXS0tU2VtYW50aWM8YnIvPkFuYWx5c2lzLS0-SVItLU9wdGltaXplZC0tPlNTQUlSW1NTQTxici8-SVJdLS1PcHRpbWl6ZWQtLT5WTUluc3RydWN0aW9uR2VuZXJhdG9yW1ZNPGJyLz5JbnN0cnVjdGlvbjxici8-R2VuZXJhdG9yXS0tPlZNSW5zdHJ1Y3Rpb25zW1ZNPGJyLz5JbnN0cnVjdGlvbnNdLS1PcHRtaXplZC0tPkJ5dGVjb2RlLS0-Vk0iLCJtZXJtYWlkIjp7InRoZW1lIjoiZGVmYXVsdCJ9LCJ1cGRhdGVFZGl0b3IiOmZhbHNlLCJhdXRvU3luYyI6dHJ1ZSwidXBkYXRlRGlhZ3JhbSI6ZmFsc2V9)

1. Read source code from file, put it into lexer and get the tokens.
2. Put tokens to the parser, and get the AST.
3. Simple semantic analysis(variable and function declaration), generate IR and optimize.
4. Constructing dominator tree, build the SSA IR.
5. Optimizations(SSA Based).
6. VM bytecode generation(peephole optimizations).
7. Write bytecode to file or interpret it.

# Build

```bash
mkdir build
cd build
cmake ..
cmake --build .
```
# Usage

```shell
# run build/cyx2

Usage:
    cyx2 [options] [src file]
    cyx2 -i-bytecode <bytecode file>
where options include:
    -ssa
      enable SSA mode, default is disabled
    -constant-folding
      enable constant folding(SSA based)
    -constant-propagation
      enable constant propagation(constant folding and SSA based)
    -no-code-simplify
      disable clearing temporary variables(after normal ir construction)
    -no-cfg-simplify
      disable clearing redundant basicblocks(empty and useless basicblocks)
    -remove-unused-code
      remove unused variable definitions, base on normal IR(aggressively)
    -dead-code-elimination
      dead code elimination(SSA based)
    -peephole
      enable peephole optimization(base on bytecode)
    -dump-cfg
      dump CFG(Graphviz), dump to stdout if `-dump-as-file` is not set
    -dump-ir
      dump IR, dump to stdout if `-dump-as-file` is not set
    -dump-ast
      dump AST(Graphviz), dump to stdout if `-dump-as-file` is not set
    -dump-vm-inst
      dump vm instructions, dump to stdout if `-dump-as-file` is not set
    -dump-as-file
      dump (cfg, ir, ast) as file, if not set `-o-`, `cyx.TYPE` is default
    -o-ast
      <destination file> dump AST to file
    -o-ir
      <destination file> dump IR to file
    -o-cfg
      <destination file> dump CFG to file
    -o-vm-inst
      <destination file> dump vm instructions(text) to file
    -o-bytecode
      <destination file> dump bytecode(binary) to file
    -i-bytecode
      <bytecode file> only virtual machine mode, no compiler

```

Using Text editor to open the dumped AST/IR/CFG files and copy the contents to GraphViz website, and you will see what you want to see, it helps me find some bugs and fix it.

# Test

Including a lot of test sets, but not comprehensive.

run `build/cyx2_test` for more details.

# Thanks

## 3rd parties

* Google Test
* dbg-macro
* GraphViz


